<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neon Velocity Typer V4</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700;800&display=swap');

        body {
            font-family: 'JetBrains Mono', monospace;
            background-color: #0f172a;
            color: #e2e8f0;
            overflow: hidden;
        }

        /* --- Animations & Effects --- */
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            70% { transform: translate(3px, 1px) rotate(-1deg); }
            80% { transform: translate(-1px, -1px) rotate(1deg); }
            90% { transform: translate(1px, 2px) rotate(0deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }
        .animate-shake { animation: shake 0.5s; }
        .neon-text { text-shadow: 0 0 5px rgba(59, 130, 246, 0.5); }

        /* Word Styling */
        .word-display span.correct { color: #4ade80; text-shadow: 0 0 10px #4ade80; }
        .word-display span.current { background-color: #3b82f6; color: white; border-radius: 2px; }
        .word-display span.incorrect { color: #ef4444; text-decoration: underline; }

        /* Particles */
        .particle { position: absolute; pointer-events: none; animation: fadeOut 1s forwards; }
        @keyframes fadeOut { to { opacity: 0; transform: translateY(-20px) scale(0); } }

        /* Containers */
        .game-container {
            backdrop-filter: blur(10px);
            background: rgba(15, 23, 42, 0.9);
            border: 1px solid rgba(59, 130, 246, 0.3);
            box-shadow: 0 0 50px rgba(59, 130, 246, 0.1);
        }

        /* Youtube Embed Helper */
        .youtube-embed-container { position: absolute; top: -9999px; left: -9999px; visibility: hidden; width: 1px; height: 1px; }

        /* Music Bar Styles */
        .music-progress-container {
            background: rgba(255, 255, 255, 0.1);
            height: 4px;
            border-radius: 2px;
            overflow: hidden;
            flex-grow: 1;
            margin: 0 10px;
            position: relative;
        }
        .music-progress-fill {
            background: #3b82f6;
            height: 100%;
            width: 0%;
            transition: width 0.1s linear;
        }
    </style>
</head>
<body class="h-screen w-screen flex flex-col items-center justify-center relative bg-[url('https://images.unsplash.com/photo-1550751827-4bd374c3f58b?q=80&w=2070&auto=format&fit=crop')] bg-cover bg-center">
    
    <div class="absolute inset-0 bg-slate-900/90 z-0"></div>

    <!-- Main Wrapper -->
    <div class="z-10 w-full max-w-3xl p-4 h-full max-h-screen overflow-y-auto no-scrollbar relative flex flex-col">
        
        <!-- Header & Language Switcher -->
        <header class="flex justify-between items-center mb-6 sticky top-0 z-20 shrink-0">
            <h1 class="text-2xl md:text-3xl font-bold tracking-tighter text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-500 neon-text">
                VELOCITY<span id="trans-title-suffix" class="text-white">TYPER</span>
            </h1>
            <div class="flex gap-2 text-xs md:text-sm font-bold">
                <button id="lang-id" class="px-2 md:px-3 py-1 rounded border transition active">INDONESIA</button>
                <button id="lang-en" class="px-2 md:px-3 py-1 rounded border transition opacity-50">ENGLISH</button>
            </div>
        </header>

        <!-- GAME AREA -->
        <div id="game-box" class="game-container rounded-2xl p-6 md:p-8 text-center relative overflow-hidden hidden mb-4 min-h-[450px] flex flex-col justify-between">
            
            <!-- In-Game Controls (Top Right) -->
            <div class="absolute top-4 right-4 flex gap-2 z-30">
                <button onclick="togglePause()" class="w-10 h-10 rounded-full bg-slate-700 hover:bg-slate-600 text-white flex items-center justify-center transition border border-slate-600">
                    <i class="fas fa-pause"></i>
                </button>
                <button onclick="confirmExit()" class="w-10 h-10 rounded-full bg-red-500/20 hover:bg-red-500 hover:text-white text-red-400 flex items-center justify-center transition border border-red-500/30">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- HUD -->
            <div class="flex justify-between items-center text-slate-400 text-xs md:text-sm uppercase tracking-widest mt-4 shrink-0">
                <div class="flex flex-col items-start">
                    <span id="trans-hud-time">Waktu</span>
                    <span id="timer" class="text-3xl md:text-4xl font-bold text-white">60</span>
                </div>
                <div class="flex flex-col items-center">
                    <span id="trans-hud-combo">Combo</span>
                    <span id="combo" class="text-xl md:text-2xl font-bold text-yellow-400">x1</span>
                </div>
                <div class="flex flex-col items-end">
                    <span id="trans-hud-score">Skor</span>
                    <span id="score" class="text-3xl md:text-4xl font-bold text-white">0</span>
                </div>
            </div>

            <!-- The Word Area (Center) -->
            <div class="relative flex-grow flex flex-col items-center justify-center my-2">
                <div id="word-display" class="text-5xl md:text-7xl font-bold tracking-wide transition-all duration-100 select-none break-words max-w-full z-10"></div>
                <div id="feedback-msg" class="absolute bottom-10 text-sm font-bold opacity-0 transition-opacity text-yellow-400"></div>
                
                <div class="mt-8 text-slate-500 text-sm">
                    <i class="fas fa-keyboard mr-2 animate-pulse"></i> <span id="trans-game-hint">Ketik kata di atas secepat mungkin</span>
                </div>
            </div>

            <!-- Music & Visualizer Section (Bottom) -->
            <div class="relative w-full mt-4 shrink-0">
                 <!-- Visualizer Canvas -->
                 <canvas id="visualizer-canvas" class="w-full h-16 rounded mb-2 opacity-80" width="600" height="100"></canvas>
                 
                 <!-- Music Controls -->
                 <div id="music-controls" class="flex items-center justify-between bg-slate-800/50 p-2 rounded-lg border border-slate-700/50">
                    <button id="btn-music-play" onclick="toggleMusicPlayback()" class="w-8 h-8 flex items-center justify-center rounded-full bg-blue-500/20 text-blue-400 hover:bg-blue-500 hover:text-white transition">
                        <i class="fas fa-pause text-xs" id="icon-music-state"></i>
                    </button>
                    
                    <div class="music-progress-container">
                        <div id="music-progress-fill" class="music-progress-fill"></div>
                    </div>
                    
                    <div id="music-time-display" class="text-[10px] font-mono text-slate-400 w-16 text-right">00:00</div>
                 </div>
            </div>

            <!-- Time Progress Bar (Top Edge) -->
            <div class="absolute top-0 left-0 w-full h-1 bg-slate-800">
                <div id="time-bar" class="h-full bg-gradient-to-r from-blue-500 to-purple-500 transition-all duration-1000 ease-linear" style="width: 100%"></div>
            </div>

            <!-- Pause Overlay -->
            <div id="pause-overlay" class="hidden absolute inset-0 bg-slate-900/95 z-40 flex flex-col items-center justify-center backdrop-blur-sm">
                <h2 class="text-4xl font-bold text-white mb-8 tracking-widest">PAUSED</h2>
                <button onclick="togglePause()" class="px-8 py-3 bg-blue-600 hover:bg-blue-500 text-white rounded-full font-bold transition flex items-center">
                    <i class="fas fa-play mr-2"></i> <span id="trans-btn-resume">LANJUTKAN</span>
                </button>
            </div>
        </div>

        <!-- MENU AREA -->
        <div id="menu-box" class="game-container rounded-2xl p-6 md:p-10 text-center mb-4">
            <div class="mb-6">
                <i class="fas fa-bolt text-5xl text-yellow-400 mb-4 animate-bounce"></i>
                <h2 id="trans-ready-title" class="text-3xl font-bold text-white mb-2">SIAP MENGETIK?</h2>
                <p id="trans-ready-desc" class="text-slate-400">Uji kecepatan jari dan akurasi Anda.</p>
            </div>
            
            <div class="grid grid-cols-3 gap-2 md:gap-4 mb-6">
                <div class="p-3 bg-slate-800/50 rounded-lg border border-slate-700">
                    <div class="text-lg md:text-2xl font-bold text-blue-400 mb-1">Easy</div>
                    <div id="trans-diff-easy" class="text-[10px] md:text-xs text-slate-500">Kata Pendek</div>
                </div>
                <div class="p-3 bg-slate-800/50 rounded-lg border border-slate-700">
                    <div class="text-lg md:text-2xl font-bold text-purple-400 mb-1">Medium</div>
                    <div id="trans-diff-med" class="text-[10px] md:text-xs text-slate-500">Kata Sedang</div>
                </div>
                <div class="p-3 bg-slate-800/50 rounded-lg border border-slate-700">
                    <div class="text-lg md:text-2xl font-bold text-pink-400 mb-1">Hard</div>
                    <div id="trans-diff-hard" class="text-[10px] md:text-xs text-slate-500">Kata Panjang</div>
                </div>
            </div>

             <!-- Music Settings -->
             <div class="mb-8 p-4 bg-slate-800/70 rounded-xl text-left border border-slate-700/50">
                <h3 class="text-white font-bold mb-3 flex items-center">
                    <i class="fas fa-music mr-2 text-blue-400"></i> <span id="trans-music-title">Musik Latar</span>
                </h3>
                
                <div class="flex flex-wrap gap-4 mb-4 text-sm">
                    <div class="flex items-center">
                        <input id="music-off" type="radio" name="music-source" value="off" class="peer hidden" checked>
                        <label for="music-off" class="flex items-center cursor-pointer text-slate-400 peer-checked:text-blue-400 peer-checked:font-bold transition-all">
                            <div class="w-4 h-4 mr-2 rounded-full border border-slate-400 peer-checked:border-blue-400 peer-checked:bg-blue-400 relative"></div>
                            Off
                        </label>
                    </div>

                    <div class="flex items-center">
                        <input id="music-local" type="radio" name="music-source" value="local" class="peer hidden">
                        <label for="music-local" class="flex items-center cursor-pointer text-slate-400 peer-checked:text-blue-400 peer-checked:font-bold transition-all">
                            <div class="w-4 h-4 mr-2 rounded-full border border-slate-400 peer-checked:border-blue-400 peer-checked:bg-blue-400 relative"></div>
                            Local File
                        </label>
                    </div>

                    <div class="flex items-center">
                        <input id="music-youtube" type="radio" name="music-source" value="youtube" class="peer hidden">
                        <label for="music-youtube" class="flex items-center cursor-pointer text-slate-400 peer-checked:text-blue-400 peer-checked:font-bold transition-all">
                            <div class="w-4 h-4 mr-2 rounded-full border border-slate-400 peer-checked:border-blue-400 peer-checked:bg-blue-400 relative"></div>
                            YouTube
                        </label>
                    </div>
                </div>

                <div id="input-local-container" class="hidden mt-3 p-3 bg-slate-900/50 rounded-lg border border-slate-700">
                    <input type="file" id="local-audio-file" accept="audio/*" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-600 file:text-white hover:file:bg-blue-700 cursor-pointer">
                    <p class="text-xs text-slate-500 mt-2 italic" id="trans-local-hint">*Pilih file audio (mp3, wav).</p>
                </div>

                <div id="input-youtube-container" class="hidden mt-3 p-3 bg-slate-900/50 rounded-lg border border-slate-700">
                    <input type="text" id="youtube-id-input" placeholder="Paste YouTube Link here..." class="w-full p-2 rounded bg-slate-800 border border-slate-600 text-white focus:border-blue-500 outline-none text-sm font-mono placeholder-slate-600">
                    <p class="text-xs text-slate-500 mt-2 italic" id="trans-youtube-hint">*Masukkan Link YouTube penuh atau ID video.</p>
                </div>
            </div>

            <button onclick="startGame()" class="w-full md:w-auto px-8 py-4 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-500 hover:to-purple-500 text-white font-bold rounded-full text-xl shadow-lg shadow-blue-500/30 transform hover:scale-105 transition-all active:scale-95">
                <span id="trans-btn-start">MULAI GAME</span> <i class="fas fa-play ml-2"></i>
            </button>
        </div>

        <!-- GAME OVER MODAL -->
        <div id="game-over-box" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm">
            <div class="game-container p-8 rounded-2xl text-center max-w-md w-full border-2 border-red-500/50 animate-pulse relative">
                <h2 id="trans-go-title" class="text-3xl md:text-4xl font-bold text-white mb-2">WAKTU HABIS!</h2>
                <div class="bg-slate-800/80 rounded-lg p-6 mb-6">
                    <div id="trans-go-final-score" class="text-sm text-slate-400 uppercase tracking-widest mb-1">Skor Akhir</div>
                    <div id="final-score" class="text-5xl md:text-6xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-yellow-400 to-orange-500 mb-4">0</div>
                    <div class="grid grid-cols-2 gap-4 text-left mb-4">
                        <div class="bg-slate-900/50 p-2 rounded">
                            <span id="trans-go-accuracy" class="text-xs text-slate-500 block">Akurasi</span>
                            <span id="final-accuracy" class="text-xl font-bold text-white">0%</span>
                        </div>
                        <div class="bg-slate-900/50 p-2 rounded">
                            <span class="text-xs text-slate-500 block">WPM</span>
                            <span id="final-wpm" class="text-xl font-bold text-white">0</span>
                        </div>
                    </div>
                     <div class="border-t border-slate-700 pt-4">
                        <div id="trans-go-analysis-title" class="text-xs text-blue-400 uppercase tracking-widest mb-2">Analisis Performa</div>
                        <p id="final-analysis" class="text-white italic text-sm leading-relaxed"></p>
                     </div>
                </div>
                <button onclick="resetGame()" class="w-full px-6 py-3 bg-white text-slate-900 font-bold rounded hover:bg-gray-200 transition active:scale-95">
                    <span id="trans-btn-retry">COBA LAGI</span> <i class="fas fa-redo ml-2"></i>
                </button>
            </div>
        </div>

        <!-- EXIT MODAL -->
        <div id="exit-confirm-modal" class="hidden fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/90 backdrop-blur-md">
            <div class="bg-slate-800 p-6 rounded-xl border border-slate-600 max-w-sm w-full text-center shadow-2xl">
                <i class="fas fa-exclamation-triangle text-yellow-400 text-3xl mb-4"></i>
                <h3 class="text-xl font-bold text-white mb-2" id="trans-exit-title">Keluar Game?</h3>
                <p class="text-slate-400 mb-6 text-sm" id="trans-exit-desc">Progres permainan saat ini akan hilang.</p>
                <div class="flex gap-3 justify-center">
                    <button onclick="cancelExit()" class="px-4 py-2 rounded bg-slate-700 hover:bg-slate-600 text-white transition text-sm">Cancel</button>
                    <button onclick="doExit()" class="px-4 py-2 rounded bg-red-600 hover:bg-red-500 text-white font-bold transition text-sm">Exit Game</button>
                </div>
            </div>
        </div>

        <input type="text" id="hidden-input" class="opacity-0 absolute top-0 left-0 h-0 w-0" autocomplete="off">
        <audio id="bg-music-local" class="hidden" crossorigin="anonymous"></audio>
        <div class="youtube-embed-container">
            <iframe id="youtube-iframe" width="1" height="1" src="" frameborder="0" allow="autoplay; encrypted-media"></iframe>
        </div>
    </div>

    <!-- Game Logic -->
    <script>
        // --- LOCALIZATION & WORDS (Same as before) ---
        const translations = {
            ID: {
                titleSuffix: "TYPER", hudTime: "Waktu", hudCombo: "Combo", hudScore: "Skor",
                gameHint: "Ketik kata di atas secepat mungkin", readyTitle: "SIAP MENGETIK?",
                readyDesc: "Uji kecepatan jari dan akurasi Anda.", diffEasy: "Kata Pendek", diffMed: "Kata Sedang",
                diffHard: "Kata Panjang", musicTitle: "Musik Latar", localHint: "*Pilih file audio (mp3, wav).",
                youtubeHint: "*Masukkan Link YouTube penuh.", btnStart: "MULAI GAME", btnResume: "LANJUTKAN",
                goTitle: "WAKTU HABIS!", goDesc: "Permainan selesai.", goFinalScore: "Skor Akhir",
                goAccuracy: "Akurasi", goAnalysisTitle: "Analisis Performa", btnRetry: "COBA LAGI",
                exitTitle: "Keluar Game?", exitDesc: "Progres akan hilang.",
                feedbackPerfect: "SEMPURNA!", feedbackGood: "BAGUS!", feedbackTime: "+2dtk",
                analysisTier1: "Kecepatan dasar. Perlu latihan lagi.",
                analysisTier2: "Lumayan, mendekati rata-rata.",
                analysisTier3: "Hebat! Di atas rata-rata.",
                analysisTier4: "Luar biasa! Tingkat dewa."
            },
            EN: {
                titleSuffix: "TYPER", hudTime: "Time", hudCombo: "Combo", hudScore: "Score",
                gameHint: "Type words fast!", readyTitle: "READY TO TYPE?",
                readyDesc: "Test speed and accuracy.", diffEasy: "Short Words", diffMed: "Medium Words",
                diffHard: "Long Words", musicTitle: "Background Music", localHint: "*Select audio file.",
                youtubeHint: "*Enter YouTube Link.", btnStart: "START GAME", btnResume: "RESUME",
                goTitle: "TIME'S UP!", goDesc: "Game over.", goFinalScore: "Final Score",
                goAccuracy: "Accuracy", goAnalysisTitle: "Performance Analysis", btnRetry: "TRY AGAIN",
                exitTitle: "Exit Game?", exitDesc: "Progress lost.",
                feedbackPerfect: "PERFECT!", feedbackGood: "GOOD!", feedbackTime: "+2s",
                analysisTier1: "Basic speed. Keep practicing.",
                analysisTier2: "Not bad, nearly average.",
                analysisTier3: "Great! Above average.",
                analysisTier4: "Incredible! God-tier speed."
            }
        };

        const wordsData = {
            ID: ["buku", "meja", "lari", "sapi", "kuda", "mata", "kaki", "susu", "bola", "ikan", "pintu", "rumah", "makan", "minum", "tidur", "hujan", "panas", "dingin", "jalan", "cepat", "sekolah", "belajar", "komputer", "telepon", "jendela", "bendera", "garuda", "jakarta", "indonesia", "merdeka", "keluarga", "sahabat", "bermain", "musik", "gitar", "piano", "dokter", "polisi", "kantor", "pasar", "tanggungjawab", "universitas", "perpustakaan", "pembangunan", "kesejahteraan", "kebudayaan", "pariwisata", "teknologi", "komunikasi", "transportasi"],
            EN: ["cat", "dog", "sun", "run", "sky", "red", "blue", "one", "two", "box", "tree", "bird", "fish", "jump", "walk", "book", "pen", "desk", "home", "star", "school", "friend", "family", "planet", "guitar", "music", "summer", "winter", "garden", "market", "doctor", "police", "artist", "writer", "player", "gamer", "coder", "happy", "smile", "dance", "extraordinary", "philosophy", "knowledge", "university", "library", "adventure", "challenge", "beautiful", "wonderful", "technology", "communication"]
        };

        // --- GAME STATE ---
        let state = {
            lang: 'ID', score: 0, timeLeft: 60, isPlaying: false, isPaused: false,
            currentWord: '', currentIndex: 0, combo: 1, correctKeystrokes: 0,
            totalKeystrokes: 0, wordsCompleted: 0, musicSource: 'off',
            musicPlaying: false
        };

        let timerInterval;
        let visualizerInterval;
        let analyser, dataArray, audioSrc;
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)(); // For SFX
        let musicCtx; // Separate context for music visualization

        // --- DOM REFERENCE ---
        const els = {
            menuBox: document.getElementById('menu-box'),
            gameBox: document.getElementById('game-box'),
            gameOverBox: document.getElementById('game-over-box'),
            exitConfirmModal: document.getElementById('exit-confirm-modal'),
            pauseOverlay: document.getElementById('pause-overlay'),
            wordDisplay: document.getElementById('word-display'),
            timer: document.getElementById('timer'),
            timeBar: document.getElementById('time-bar'),
            score: document.getElementById('score'),
            combo: document.getElementById('combo'),
            input: document.getElementById('hidden-input'),
            feedback: document.getElementById('feedback-msg'),
            finalScore: document.getElementById('final-score'),
            finalAccuracy: document.getElementById('final-accuracy'),
            finalWpm: document.getElementById('final-wpm'),
            finalAnalysis: document.getElementById('final-analysis'),
            btnId: document.getElementById('lang-id'),
            btnEn: document.getElementById('lang-en'),
            musicRadios: document.getElementsByName('music-source'),
            inputLocalContainer: document.getElementById('input-local-container'),
            inputYoutubeContainer: document.getElementById('input-youtube-container'),
            localAudioFile: document.getElementById('local-audio-file'),
            youtubeIdInput: document.getElementById('youtube-id-input'),
            bgMusicLocal: document.getElementById('bg-music-local'),
            youtubeIframe: document.getElementById('youtube-iframe'),
            visualizerCanvas: document.getElementById('visualizer-canvas'),
            musicControls: document.getElementById('music-controls'),
            musicProgressFill: document.getElementById('music-progress-fill'),
            musicTimeDisplay: document.getElementById('music-time-display'),
            iconMusicState: document.getElementById('icon-music-state'),
            transIds: ['trans-title-suffix', 'trans-hud-time', 'trans-hud-combo', 'trans-hud-score', 'trans-game-hint', 'trans-ready-title', 'trans-ready-desc', 'trans-diff-easy', 'trans-diff-med', 'trans-diff-hard', 'trans-music-title', 'trans-local-hint', 'trans-youtube-hint', 'trans-btn-start', 'trans-go-title', 'trans-go-desc', 'trans-go-final-score', 'trans-go-accuracy', 'trans-go-analysis-title', 'trans-btn-retry', 'trans-btn-resume', 'trans-exit-title', 'trans-exit-desc']
        };

        // --- HELPER: YouTube ID ---
        function getYoutubeId(url) {
            if (!url) return null;
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
            const match = url.match(regExp);
            return (match && match[2].length === 11) ? match[2] : (url.length === 11 ? url : null);
        }

        // --- LOCALIZATION ---
        function updateInterfaceLanguage() {
            const t = translations[state.lang];
            els.transIds.forEach(id => {
                const el = document.getElementById(id);
                const key = id.replace('trans-', '').replace(/-([a-z])/g, g => g[1].toUpperCase());
                if (el && t[key]) el.innerText = t[key];
            });
            els.btnId.className = state.lang === 'ID' ? "px-2 md:px-3 py-1 rounded border transition active bg-blue-500/20 border-blue-500" : "px-2 md:px-3 py-1 rounded border transition opacity-50";
            els.btnEn.className = state.lang === 'EN' ? "px-2 md:px-3 py-1 rounded border transition active bg-blue-500/20 border-blue-500" : "px-2 md:px-3 py-1 rounded border transition opacity-50";
        }
        els.btnId.addEventListener('click', () => { state.lang = 'ID'; updateInterfaceLanguage(); });
        els.btnEn.addEventListener('click', () => { state.lang = 'EN'; updateInterfaceLanguage(); });

        // --- MUSIC HANDLING ---
        els.musicRadios.forEach(radio => {
            radio.addEventListener('change', (e) => {
                state.musicSource = e.target.value;
                els.inputLocalContainer.classList.add('hidden');
                els.inputYoutubeContainer.classList.add('hidden');
                stopMusic();
                if (state.musicSource === 'local') els.inputLocalContainer.classList.remove('hidden');
                else if (state.musicSource === 'youtube') els.inputYoutubeContainer.classList.remove('hidden');
            });
        });

        // Setup Visualizer & Audio Context for Music
        function setupMusicVisualizer() {
            if (state.musicSource !== 'local') return;
            if (!musicCtx) {
                musicCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioSrc) { audioSrc.disconnect(); } // clean up prev
            
            try {
                audioSrc = musicCtx.createMediaElementSource(els.bgMusicLocal);
                analyser = musicCtx.createAnalyser();
                audioSrc.connect(analyser);
                analyser.connect(musicCtx.destination);
                analyser.fftSize = 64;
                const bufferLength = analyser.frequencyBinCount;
                dataArray = new Uint8Array(bufferLength);
            } catch(e) { console.log("CORS/Audio Source Error (Ignorable for now):", e); }
        }

        function drawVisualizer() {
            const canvas = els.visualizerCanvas;
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            
            ctx.clearRect(0, 0, width, height);
            
            let bars = 30;
            let barWidth = width / bars;
            let barHeight;
            let x = 0;

            if (state.musicSource === 'local' && state.musicPlaying && analyser) {
                analyser.getByteFrequencyData(dataArray);
                // Use real data
                for (let i = 0; i < bars; i++) {
                    // Map bars to frequency data index
                    let idx = Math.floor(i * (dataArray.length / bars));
                    let value = dataArray[idx];
                    barHeight = (value / 255) * height;

                    ctx.fillStyle = `rgb(${value + 50}, 50, 255)`;
                    ctx.fillRect(x, height - barHeight, barWidth - 2, barHeight);
                    x += barWidth;
                }
            } else if (state.musicSource === 'youtube' && state.musicPlaying) {
                // Simulation for YouTube
                for (let i = 0; i < bars; i++) {
                    let seed = Math.random();
                    barHeight = seed * height * 0.6; // random height
                    ctx.fillStyle = `rgb(59, 130, 246)`; // standard blue
                    ctx.fillRect(x, height - barHeight, barWidth - 2, barHeight);
                    x += barWidth;
                }
            } else {
                 // Flat line if stopped
                ctx.fillStyle = `rgba(59, 130, 246, 0.2)`;
                ctx.fillRect(0, height - 2, width, 2);
            }

            if (state.isPlaying) requestAnimationFrame(drawVisualizer);
        }

        function startMusic() {
            state.musicPlaying = true;
            updateMusicUIState(true);
            
            if (state.musicSource === 'local') {
                const file = els.localAudioFile.files[0];
                if (file) {
                    els.bgMusicLocal.src = URL.createObjectURL(file);
                    els.bgMusicLocal.play()
                        .then(() => setupMusicVisualizer())
                        .catch(e => console.log("Playback failed:", e));
                }
            } else if (state.musicSource === 'youtube') {
                const videoId = getYoutubeId(els.youtubeIdInput.value.trim());
                if (videoId) {
                    els.youtubeIframe.src = `https://www.youtube.com/embed/${videoId}?autoplay=1&loop=1&enablejsapi=1&controls=0&showinfo=0`;
                }
            }
        }

        function stopMusic() {
            state.musicPlaying = false;
            updateMusicUIState(false);
            els.bgMusicLocal.pause();
            els.bgMusicLocal.currentTime = 0;
            els.youtubeIframe.src = "";
        }

        function toggleMusicPlayback() {
            if (state.musicSource === 'off') return;
            state.musicPlaying = !state.musicPlaying;
            updateMusicUIState(state.musicPlaying);

            if (state.musicPlaying) {
                if(state.musicSource === 'local') els.bgMusicLocal.play();
                else if (state.musicSource === 'youtube') {
                    // Try postMessage for YouTube
                    els.youtubeIframe.contentWindow.postMessage('{"event":"command","func":"playVideo","args":""}', '*');
                }
            } else {
                if(state.musicSource === 'local') els.bgMusicLocal.pause();
                else if (state.musicSource === 'youtube') {
                    els.youtubeIframe.contentWindow.postMessage('{"event":"command","func":"pauseVideo","args":""}', '*');
                }
            }
        }

        function updateMusicUIState(isPlaying) {
            if (isPlaying) {
                els.iconMusicState.className = "fas fa-pause text-xs";
            } else {
                els.iconMusicState.className = "fas fa-play text-xs";
            }
        }

        // Music Progress Logic
        els.bgMusicLocal.addEventListener('timeupdate', () => {
            if(state.musicSource === 'local') {
                const pct = (els.bgMusicLocal.currentTime / els.bgMusicLocal.duration) * 100;
                els.musicProgressFill.style.width = `${pct}%`;
                
                // Format time
                const mins = Math.floor(els.bgMusicLocal.currentTime / 60);
                const secs = Math.floor(els.bgMusicLocal.currentTime % 60);
                els.musicTimeDisplay.innerText = `${mins}:${secs.toString().padStart(2, '0')}`;
            }
        });

        // --- SFX ---
        function playSfx(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            osc.connect(gainNode); gainNode.connect(audioCtx.destination);
            const now = audioCtx.currentTime;

            if (type === 'type') {
                osc.type = 'square'; osc.frequency.setValueAtTime(600, now); osc.frequency.exponentialRampToValueAtTime(300, now + 0.05);
                gainNode.gain.setValueAtTime(0.05, now); gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.05);
                osc.start(now); osc.stop(now + 0.05);
            } else if (type === 'error') {
                osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, now); osc.frequency.linearRampToValueAtTime(100, now + 0.2);
                gainNode.gain.setValueAtTime(0.1, now); gainNode.gain.linearRampToValueAtTime(0.001, now + 0.2);
                osc.start(now); osc.stop(now + 0.2);
            } else if (type === 'success') {
                osc.type = 'sine'; osc.frequency.setValueAtTime(500 + (state.combo * 50), now);
                gainNode.gain.setValueAtTime(0.1, now); gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.3);
                osc.start(now); osc.stop(now + 0.3);
            }
        }

        // --- VISUALS ---
        function createParticles(x, y) {
            for (let i = 0; i < 8; i++) {
                const p = document.createElement('div');
                p.className = 'particle bg-blue-500 rounded-full';
                p.style.left = x + 'px'; p.style.top = y + 'px';
                const size = Math.random() * 6 + 2; p.style.width = size+'px'; p.style.height = size+'px';
                const tx = (Math.random()-0.5)*100; const ty = (Math.random()-0.5)*100;
                document.body.appendChild(p);
                p.animate([{transform:'translate(0,0) scale(1)', opacity:1},{transform:`translate(${tx}px,${ty}px) scale(0)`, opacity:0}],{duration:600,fill:'forwards'});
                setTimeout(()=>p.remove(),600);
            }
        }

        function showFeedback(text, color) {
            els.feedback.innerText = text; els.feedback.style.color = color;
            els.feedback.style.opacity = '1'; els.feedback.style.transform = 'translateY(-15px)';
            setTimeout(()=>{els.feedback.style.opacity='0';els.feedback.style.transform='translateY(0)';},600);
        }

        // --- GAME CORE ---
        function startGame() {
            state.score = 0; state.timeLeft = 60; state.combo = 1;
            state.wordsCompleted = 0; state.totalKeystrokes = 0; state.correctKeystrokes = 0;
            state.isPlaying = true; state.isPaused = false;

            els.menuBox.classList.add('hidden'); els.gameOverBox.classList.add('hidden');
            els.exitConfirmModal.classList.add('hidden'); els.gameBox.classList.remove('hidden');
            els.timer.classList.remove('text-red-500'); els.timeBar.classList.add('from-blue-500', 'to-purple-500');
            els.timeBar.classList.remove('bg-red-500'); els.gameBox.classList.remove('animate-pulse', 'border-red-500/50');
            els.pauseOverlay.classList.add('hidden');
            
            // Show music controls only if music is active
            els.musicControls.style.visibility = state.musicSource === 'off' ? 'hidden' : 'visible';
            
            // Reset Progress Bar Visuals
            els.musicProgressFill.style.width = '0%';
            els.musicTimeDisplay.innerText = state.musicSource === 'youtube' ? 'LIVE' : '00:00';

            updateHUD(); nextWord(); startMusic();
            requestAnimationFrame(drawVisualizer); // Start Visualizer Loop
            
            els.input.value = ''; els.input.focus();
            clearInterval(timerInterval);
            timerInterval = setInterval(gameLoop, 1000);
        }

        function gameLoop() {
            if (!state.isPlaying || state.isPaused) return;
            state.timeLeft--;
            els.timer.innerText = state.timeLeft;
            els.timeBar.style.width = (state.timeLeft / 60 * 100) + '%';
            if (state.timeLeft <= 10) {
                els.timer.classList.add('text-red-500');
                els.timeBar.classList.remove('from-blue-500', 'to-purple-500'); els.timeBar.classList.add('bg-red-500');
                els.gameBox.classList.add('animate-pulse', 'border-red-500/50');
            }
            if (state.timeLeft <= 0) endGame();
        }

        function togglePause() {
            if (!state.isPlaying) return;
            state.isPaused = !state.isPaused;
            if (state.isPaused) {
                els.pauseOverlay.classList.remove('hidden');
                // Pause music logically when game pauses? Usually yes.
                if(state.musicPlaying) {
                    if(state.musicSource === 'local') els.bgMusicLocal.pause();
                    // Keep YouTube playing or pause it? Let's pause it for immersion break.
                    if(state.musicSource === 'youtube') els.youtubeIframe.contentWindow.postMessage('{"event":"command","func":"pauseVideo","args":""}', '*');
                }
            } else {
                els.pauseOverlay.classList.add('hidden');
                // Resume music if it was playing
                if(state.musicPlaying) {
                    if(state.musicSource === 'local') els.bgMusicLocal.play();
                    if(state.musicSource === 'youtube') els.youtubeIframe.contentWindow.postMessage('{"event":"command","func":"playVideo","args":""}', '*');
                }
                els.input.focus();
            }
        }

        function confirmExit() { state.isPaused = true; els.pauseOverlay.classList.add('hidden'); els.exitConfirmModal.classList.remove('hidden'); }
        function cancelExit() { els.exitConfirmModal.classList.add('hidden'); state.isPaused = true; els.pauseOverlay.classList.remove('hidden'); }
        function doExit() { stopMusic(); state.isPlaying = false; clearInterval(timerInterval); els.exitConfirmModal.classList.add('hidden'); els.gameBox.classList.add('hidden'); els.menuBox.classList.remove('hidden'); }

        function nextWord() {
            const list = wordsData[state.lang];
            let lenFilter = state.score < 50 ? w=>w.length<=4 : state.score < 150 ? w=>w.length>3&&w.length<=7 : w=>w.length>5;
            let candidates = list.filter(lenFilter);
            if (candidates.length === 0) candidates = list;
            state.currentWord = candidates[Math.floor(Math.random() * candidates.length)];
            state.currentIndex = 0;
            renderWord();
        }

        function renderWord() {
            els.wordDisplay.innerHTML = '';
            state.currentWord.split('').forEach((char, i) => {
                const span = document.createElement('span'); span.innerText = char;
                if (i < state.currentIndex) span.className = 'correct';
                else if (i === state.currentIndex) span.className = 'current px-1 mx-[1px]';
                else span.className = 'text-slate-600';
                els.wordDisplay.appendChild(span);
            });
        }

        document.addEventListener('click', (e) => {
            const isControl = e.target.closest('button') || e.target.closest('input') || e.target.closest('label');
            if (state.isPlaying && !state.isPaused && !isControl) els.input.focus();
        });

        document.addEventListener('keydown', (e) => {
            if (!state.isPlaying || state.isPaused) return;
            if (e.ctrlKey || e.altKey || e.metaKey) return;
            if (e.key === "Escape") { togglePause(); return; }
            if (e.key.length > 1) return;

            state.totalKeystrokes++;
            if (e.key.toLowerCase() === state.currentWord[state.currentIndex].toLowerCase()) {
                state.currentIndex++; state.correctKeystrokes++; playSfx('type');
                renderWord();
                if (state.currentIndex >= state.currentWord.length) wordCompleted();
            } else {
                state.combo = 1; playSfx('error');
                els.gameBox.classList.add('animate-shake'); setTimeout(()=>els.gameBox.classList.remove('animate-shake'),500);
                if(els.wordDisplay.children[state.currentIndex]) {
                     els.wordDisplay.children[state.currentIndex].classList.add('incorrect');
                     setTimeout(()=>els.wordDisplay.children[state.currentIndex]?.classList.remove('incorrect'), 200);
                }
                updateHUD();
            }
        });

        function wordCompleted() {
            playSfx('success');
            const points = state.currentWord.length * state.combo;
            state.score += points; state.wordsCompleted++;
            if (state.combo < 5) state.combo++;
            const rect = els.wordDisplay.getBoundingClientRect();
            createParticles(rect.left + rect.width/2, rect.top + rect.height/2);
            const t = translations[state.lang];
            if (state.currentWord.length > 5) { state.timeLeft = Math.min(state.timeLeft + 2, 60); showFeedback(t.feedbackTime, '#4ade80'); }
            else { showFeedback(t.feedbackPerfect, '#fbbf24'); }
            updateHUD(); nextWord();
        }

        function updateHUD() {
            els.score.innerText = state.score; els.combo.innerText = `x${state.combo}`;
            els.combo.className = state.combo >= 4 ? "text-xl md:text-2xl font-bold text-red-500 animate-pulse" : state.combo >= 2 ? "text-xl md:text-2xl font-bold text-yellow-400" : "text-xl md:text-2xl font-bold text-slate-400";
        }

        function getAnalysis(wpm, lang) {
            const t = translations[lang];
            if (wpm < 20) return t.analysisTier1;
            if (wpm < 40) return t.analysisTier2;
            if (wpm < 70) return t.analysisTier3;
            return t.analysisTier4;
        }

        function endGame() {
            state.isPlaying = false; clearInterval(timerInterval); stopMusic();
            const accuracy = state.totalKeystrokes === 0 ? 0 : Math.round((state.correctKeystrokes / state.totalKeystrokes) * 100);
            const finalWpmRaw = state.wordsCompleted; 
            els.finalScore.innerText = state.score; els.finalAccuracy.innerText = accuracy + "%"; els.finalWpm.innerText = finalWpmRaw;
            els.finalAnalysis.innerText = getAnalysis(finalWpmRaw, state.lang);
            els.gameBox.classList.add('hidden'); els.gameOverBox.classList.remove('hidden');
        }

        function resetGame() { els.gameOverBox.classList.add('hidden'); els.menuBox.classList.remove('hidden'); }
        updateInterfaceLanguage();
    </script>
</body>
</html>
